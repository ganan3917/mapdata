name: è‡ªåŠ¨æ‰“åŒ…å¹¶ä¸Šä¼ Release

on:
  push:
    branches: [ main ]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    name: åœ°å›¾æ•°æ®è‡ªåŠ¨æ‰“åŒ…å‘å¸ƒæµç¨‹
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»£ç ä»“åº“
        uses: actions/checkout@v4
        description: ä»GitHubä»“åº“æ‹‰å–æœ€æ–°ä»£ç åˆ°è¿è¡Œç¯å¢ƒ

      - name: ğŸ”§ ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
        id: set_filename
        run: |
          # ç”ŸæˆåŒ…å«æ—¶é—´æˆ³çš„æ–‡ä»¶åï¼ˆæ ¼å¼ï¼šdata+å¹´æœˆæ—¥æ—¶åˆ†ç§’ï¼‰
          TIMESTAMP=$(date +"%Y%m%d%H%M%S")
          echo "FILENAME=data${TIMESTAMP}.zip" >> $GITHUB_ENV
          echo "SPLIT_PREFIX=${{ env.FILENAME }}.part" >> $GITHUB_ENV
          echo "âœ… å·²ç”Ÿæˆæ–‡ä»¶åï¼š${{ env.FILENAME }}"

      - name: ğŸ“¦ æ‰“åŒ…åœ°å›¾æ•°æ®æ–‡ä»¶
        run: |
          echo "å¼€å§‹æ‰“åŒ…æ–‡ä»¶ï¼Œæ’é™¤å†—ä½™ç›®å½•..."
          # æ‰“åŒ…æ ¸å¿ƒæ•°æ®å¹¶æ’é™¤Gitç›¸å…³æ–‡ä»¶
          zip -r ${{ env.FILENAME }} . \
            -x ".git/*" \
            -x ".gitignore" \
            -x ".github/workflows/*" \
            -x "*.zip"
          # æ˜¾ç¤ºæ‰“åŒ…ç»“æœå’Œæ–‡ä»¶å¤§å°
          echo "âœ… æ‰“åŒ…å®Œæˆï¼æ–‡ä»¶ä¿¡æ¯ï¼š"
          ls -lh ${{ env.FILENAME }}

      - name: âœ‚ï¸ å¤§æ–‡ä»¶è‡ªåŠ¨åˆ†ç‰‡å¤„ç†
        run: |
          # 1.8GB = 1932735283å­—èŠ‚ï¼ˆé¢„ç•™ç©ºé—´é¿å…è¶…è¿‡GitHub 2GBé™åˆ¶ï¼‰
          MAX_SIZE=1932735283
          FILE_SIZE=$(stat -c%s "${{ env.FILENAME }}")
          
          echo "ğŸ“ æ£€æµ‹æ–‡ä»¶å¤§å°ï¼š$((FILE_SIZE / 1024 / 1024))MB"
          
          if [ $FILE_SIZE -gt $MAX_SIZE ]; then
            echo "ğŸ” æ–‡ä»¶è¶…è¿‡1.8GBï¼Œå¯åŠ¨åˆ†ç‰‡å¤„ç†..."
            # æ‹†åˆ†ä¸º1.8GB/ä¸ªçš„åˆ†ç‰‡ï¼ˆæ•°å­—åç¼€ï¼Œå¦‚part00ã€part01ï¼‰
            split -b 1800m -d -a 2 "${{ env.FILENAME }}" "${{ env.SPLIT_PREFIX }}"
            # æ˜¾ç¤ºåˆ†ç‰‡ç»“æœ
            echo "âœ… åˆ†ç‰‡å®Œæˆï¼Œç”Ÿæˆæ–‡ä»¶ï¼š"
            ls -lh "${{ env.SPLIT_PREFIX }}"*
            # åˆ é™¤åŸå§‹å¤§æ–‡ä»¶ï¼Œé¿å…ä¸Šä¼ å—é™
            rm -f "${{ env.FILENAME }}"
          else
            echo "âœ… æ–‡ä»¶å¤§å°ç¬¦åˆè¦æ±‚ï¼Œæ— éœ€åˆ†ç‰‡"
          fi

      - name: ğŸš€ ä¸Šä¼ æ–‡ä»¶åˆ°Release
        uses: softprops/action-gh-release@v2
        with:
          name: è‡ªåŠ¨æ‰“åŒ…-${{ env.FILENAME }}
          tag_name: ${{ env.FILENAME }}
          files: |
            ${{ env.SPLIT_PREFIX }}*
            ${{ env.FILENAME }}
          body: |
            ### AzerothCore Playerbotåˆ†æ”¯ä¸“ç”¨åœ°å›¾æ•°æ®
            
            ğŸŒŸ æœ¬èµ„æºåŒ…å«è¿è¡ŒAzerothCore Playerbotåˆ†æ”¯æ‰€éœ€çš„å®Œæ•´åœ°å›¾æ•°æ®ï¼Œå…·ä½“å†…å®¹ï¼š
            - mapï¼šåŸºç¡€åœ°å›¾æ•°æ®æ–‡ä»¶
            - mmapï¼šå¯¼èˆªç½‘æ ¼æ•°æ®ï¼ˆç”¨äºNPCè·¯å¾„è®¡ç®—ï¼‰
            - dbcï¼šå®¢æˆ·ç«¯æ•°æ®åº“æ–‡ä»¶ï¼ˆå·²é›†æˆä¸­æ–‡ä¼˜åŒ–ï¼‰
            - vmapï¼šå¯è§†åœ°å›¾ç¢°æ’æ•°æ®
            - Camerasï¼šè§†è§’é…ç½®æ–‡ä»¶
            - âœ¨ ç‰¹åˆ«ä¼˜åŒ–ï¼šä¸­æ–‡DBCæ–‡ä»¶è§£å†³æœºå™¨äººæŠ€èƒ½æ˜¾ç¤ºåŠæ‰§è¡Œå¼‚å¸¸é—®é¢˜
            
            ---
            
            ğŸ“ **ä¸‹è½½ä¸ä½¿ç”¨æŒ‡å—**
            1. **å®Œæ•´æ–‡ä»¶**ï¼ˆæœªåˆ†ç‰‡ï¼‰ï¼š
               - ç›´æ¥ä¸‹è½½ `.zip` æ ¼å¼æ–‡ä»¶
               - ä½¿ç”¨WinRARã€7-Zipæˆ–ç³»ç»Ÿè‡ªå¸¦å‹ç¼©å·¥å…·è§£å‹å³å¯
            
            2. **åˆ†ç‰‡æ–‡ä»¶**ï¼ˆå¦‚æ˜¾ç¤ºä¸º`dataxxx.zip.part00`ç­‰å¤šä¸ªæ–‡ä»¶ï¼‰ï¼š
               - **Windowsç³»ç»Ÿåˆå¹¶æ–¹æ³•**ï¼š
                 1. å°†æ‰€æœ‰åˆ†ç‰‡æ–‡ä»¶æ”¾åœ¨åŒä¸€æ–‡ä»¶å¤¹ï¼ˆç¡®ä¿æ–‡ä»¶åè¿ç»­ï¼‰
                 2. æ‰“å¼€ã€Œå‘½ä»¤æç¤ºç¬¦ã€(CMD)ï¼Œè¿›å…¥è¯¥æ–‡ä»¶å¤¹
                 3. æ‰§è¡Œå‘½ä»¤ï¼š  
                    `copy /b dataxxx.zip.part* dataxxx.zip`  
                    ï¼ˆå°†`dataxxx`æ›¿æ¢ä¸ºå®é™…æ–‡ä»¶åå‰ç¼€ï¼‰
               
               - **Linux/Macç³»ç»Ÿåˆå¹¶æ–¹æ³•**ï¼š
                 1. å°†æ‰€æœ‰åˆ†ç‰‡æ–‡ä»¶æ”¾åœ¨åŒä¸€ç›®å½•
                 2. æ‰“å¼€ç»ˆç«¯ï¼Œè¿›å…¥è¯¥ç›®å½•
                 3. æ‰§è¡Œå‘½ä»¤ï¼š  
                    `cat dataxxx.zip.part* > dataxxx.zip`  
                    ï¼ˆå°†`dataxxx`æ›¿æ¢ä¸ºå®é™…æ–‡ä»¶åå‰ç¼€ï¼‰
               
               - åˆå¹¶å®Œæˆåï¼Œå¾—åˆ°å®Œæ•´`.zip`æ–‡ä»¶ï¼Œæ­£å¸¸è§£å‹å³å¯ä½¿ç”¨
            
            ---
            
            ğŸ’¡ æç¤ºï¼šåˆå¹¶åçš„æ–‡ä»¶ä¸åŸå§‹æ–‡ä»¶æ ¡éªŒä¸€è‡´ï¼Œå¯æ”¾å¿ƒç”¨äºæœåŠ¡å™¨éƒ¨ç½²
        env:
          GITHUB_TOKEN: ${{ secrets.CUSTOM_GITHUB_TOKEN }}

      - name: ğŸ§¹ æ¸…ç†å†å²ç‰ˆæœ¬
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 3  # ä»…ä¿ç•™æœ€æ–°3ä¸ªReleaseç‰ˆæœ¬
          delete_tags: true  # åŒæ—¶åˆ é™¤å¯¹åº”çš„Gitæ ‡ç­¾
        env:
          GITHUB_TOKEN: ${{ secrets.CUSTOM_GITHUB_TOKEN }}
