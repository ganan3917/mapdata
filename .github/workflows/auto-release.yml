name: è‡ªåŠ¨æ‰“åŒ…å¹¶ä¸Šä¼ Release

on:
  push:
    branches: [ main ]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    name: æ‰“åŒ…åœ°å›¾æ•°æ®å¹¶å‘å¸ƒ
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»£ç ä»“åº“
        uses: actions/checkout@v4

      - name: ğŸ”§ è®¾ç½®æ–‡ä»¶åç§°
        id: set_filename
        run: |
          # ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„å”¯ä¸€æ–‡ä»¶åï¼ˆæ ¼å¼ï¼šdata+å¹´æœˆæ—¥æ—¶åˆ†ç§’ï¼‰
          TIMESTAMP=$(date +"%Y%m%d%H%M%S")
          echo "FILENAME=data${TIMESTAMP}.zip" >> $GITHUB_ENV
          # å®šä¹‰åˆ†ç‰‡æ–‡ä»¶å‰ç¼€ï¼ˆç”¨äºåç»­ä¸Šä¼ æ‰€æœ‰åˆ†ç‰‡ï¼‰
          echo "SPLIT_PREFIX=${{ env.FILENAME }}.part" >> $GITHUB_ENV
          echo "âœ… æ–‡ä»¶åè®¾ç½®å®Œæˆï¼š${{ env.FILENAME }}"

      - name: ğŸ“¦ æ‰“åŒ…åœ°å›¾æ•°æ®
        run: |
          echo "å¼€å§‹æ‰“åŒ…æ–‡ä»¶ï¼Œæ’é™¤å†—ä½™ç›®å½•..."
          # æ‰“åŒ…å½“å‰ç›®å½•å¹¶æ’é™¤Gitç›¸å…³æ–‡ä»¶ã€å·¥ä½œæµé…ç½®å’Œå·²æœ‰zipåŒ…
          zip -r ${{ env.FILENAME }} . \
            -x ".git/*" \
            -x ".gitignore" \
            -x ".github/workflows/*" \
            -x "*.zip"
          # æ˜¾ç¤ºæ‰“åŒ…åçš„æ–‡ä»¶å¤§å°
          echo "âœ… æ‰“åŒ…å®Œæˆï¼Œæ–‡ä»¶å¤§å°ï¼š$(du -h ${{ env.FILENAME }})"

      - name: âœ‚ï¸ æ‹†åˆ†å¤§æ–‡ä»¶ï¼ˆè¶…è¿‡1.5GBæ—¶ï¼‰
        run: |
          # 1.5GB = 1610612736å­—èŠ‚ï¼ˆé¢„ç•™ç©ºé—´é¿å…è¶…GitHubé™åˆ¶ï¼‰
          MAX_SIZE=$((1500 * 1024 * 1024))  # 1500MB
          FILE_SIZE=$(stat -c%s "${{ env.FILENAME }}")
          
          echo "æ£€æµ‹æ–‡ä»¶å¤§å°ï¼š$((FILE_SIZE / 1024 / 1024))MB"
          
          if [ $FILE_SIZE -gt $MAX_SIZE ]; then
            echo "æ–‡ä»¶è¶…è¿‡1.5GBï¼Œå¼€å§‹æ‹†åˆ†..."
            # æ‹†åˆ†ä¸º1.5GB/ä¸ªçš„åˆ†ç‰‡ï¼ˆ-dä½¿ç”¨æ•°å­—åç¼€ï¼Œ-a 2æŒ‡å®š2ä½æ•°å­—ï¼‰
            split -b 1500m -d -a 2 "${{ env.FILENAME }}" "${{ env.SPLIT_PREFIX }}"
            # æ˜¾ç¤ºæ‹†åˆ†åçš„æ–‡ä»¶åˆ—è¡¨
            echo "æ‹†åˆ†ç»“æœï¼š"
            ls -lh "${{ env.SPLIT_PREFIX }}"*
            # åˆ é™¤åŸå§‹å¤§æ–‡ä»¶ï¼Œé¿å…ä¸Šä¼ æ—¶è§¦å‘é™åˆ¶
            rm -f "${{ env.FILENAME }}"
            echo "âœ… æ‹†åˆ†å®Œæˆï¼Œå…±ç”Ÿæˆ$(ls "${{ env.SPLIT_PREFIX }}"* | wc -l)ä¸ªåˆ†ç‰‡"
          else
            echo "æ–‡ä»¶æœªè¶…è¿‡1.5GBï¼Œæ— éœ€æ‹†åˆ†"
          fi

      - name: ğŸš€ ä¸Šä¼ åˆ°Release
        uses: softprops/action-gh-release@v2
        with:
          name: è‡ªåŠ¨æ‰“åŒ…-${{ env.FILENAME }}
          tag_name: ${{ env.FILENAME }}
          # ä¸Šä¼ æ‰€æœ‰åˆ†ç‰‡ï¼ˆå¦‚æœæ‹†åˆ†äº†ï¼‰æˆ–åŸå§‹æ–‡ä»¶
          files: |
            ${{ env.SPLIT_PREFIX }}*
            ${{ env.FILENAME }}
          body: |
            ### AzerothCore Playerbotåˆ†æ”¯åœ°å›¾æ•°æ®
            
            æœ¬å‹ç¼©åŒ…åŒ…å«è¿è¡ŒAzerothCore Playerbotåˆ†æ”¯æ‰€éœ€çš„å®Œæ•´åœ°å›¾æ•°æ®ï¼Œå…·ä½“å†…å®¹ï¼š
            - mapï¼šåœ°å›¾åŸºç¡€æ•°æ®
            - mmapï¼šå¯¼èˆªç½‘æ ¼æ•°æ®
            - dbcï¼šå®¢æˆ·ç«¯æ•°æ®åº“æ–‡ä»¶ï¼ˆå«ä¸­æ–‡ä¼˜åŒ–ï¼‰
            - vmapï¼šå¯è§†åœ°å›¾æ•°æ®
            - Camerasï¼šè§†è§’é…ç½®æ–‡ä»¶
            - ç‰¹åˆ«ä¼˜åŒ–ï¼šä¸­æ–‡DBCæ–‡ä»¶è§£å†³æœºå™¨äººæŠ€èƒ½æ˜¾ç¤ºåŠæ‰§è¡Œé—®é¢˜
            
            ---
            
            ### ğŸ“ ä¸‹è½½ä¸ä½¿ç”¨è¯´æ˜
            1. **å®Œæ•´æ–‡ä»¶**ï¼ˆæœªåˆ†ç‰‡ï¼‰ï¼šç›´æ¥ä¸‹è½½`.zip`æ–‡ä»¶ï¼Œç”¨å‹ç¼©è½¯ä»¶è§£å‹å³å¯
            2. **åˆ†ç‰‡æ–‡ä»¶**ï¼ˆå¦‚`dataxxx.zip.part00`ï¼‰ï¼š
               - **Windowsç³»ç»Ÿ**ï¼š
                 1. å°†æ‰€æœ‰åˆ†ç‰‡æ–‡ä»¶æ”¾åœ¨åŒä¸€æ–‡ä»¶å¤¹
                 2. æ‰“å¼€å‘½ä»¤æç¤ºç¬¦ï¼ˆCMDï¼‰ï¼Œè¿›å…¥è¯¥æ–‡ä»¶å¤¹
                 3. æ‰§è¡Œå‘½ä»¤ï¼š`copy /b dataxxx.zip.part* dataxxx.zip`ï¼ˆå°†`dataxxx`æ›¿æ¢ä¸ºå®é™…å‰ç¼€ï¼‰
               - **Linux/Macç³»ç»Ÿ**ï¼š
                 1. å°†æ‰€æœ‰åˆ†ç‰‡æ–‡ä»¶æ”¾åœ¨åŒä¸€ç›®å½•
                 2. æ‰“å¼€ç»ˆç«¯ï¼Œè¿›å…¥è¯¥ç›®å½•
                 3. æ‰§è¡Œå‘½ä»¤ï¼š`cat dataxxx.zip.part* > dataxxx.zip`ï¼ˆå°†`dataxxx`æ›¿æ¢ä¸ºå®é™…å‰ç¼€ï¼‰
               - åˆå¹¶å®Œæˆåï¼Œå¾—åˆ°å®Œæ•´`.zip`æ–‡ä»¶ï¼Œè§£å‹å³å¯ä½¿ç”¨
            
            ---
            
            æç¤ºï¼šåˆå¹¶åçš„æ–‡ä»¶ä¸åŸå§‹æ–‡ä»¶æ ¡éªŒä¸€è‡´ï¼Œå¯æ”¾å¿ƒä½¿ç”¨
        env:
          GITHUB_TOKEN: ${{ secrets.CUSTOM_GITHUB_TOKEN }}

      - name: ğŸ§¹ æ¸…ç†å†å²ç‰ˆæœ¬
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 3  # ä»…ä¿ç•™æœ€æ–°3ä¸ªRelease
          delete_tags: true  # åŒæ—¶åˆ é™¤å¯¹åº”çš„æ ‡ç­¾
        env:
          GITHUB_TOKEN: ${{ secrets.CUSTOM_GITHUB_TOKEN }}
